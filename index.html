<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Latice Chat</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: white; text-align: center; padding: 10px; margin: 0;}
        input, select { padding: 12px; width: 90%; margin: 8px 0; border-radius: 8px; border: none; background: #334155; color: white; font-size: 16px; }
        button { background-color: #3b82f6; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 10px;}
        .card { background-color: #1e293b; padding: 20px; margin: 15px auto; border-radius: 12px; text-align: left; max-width: 500px; }
        
        /* ESTILOS DEL CHAT */
        .chat-box { height: 300px; overflow-y: scroll; background: #020617; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; }
        .mensaje { padding: 8px 12px; margin: 5px; border-radius: 15px; max-width: 70%; width: fit-content; }
        .mio { background-color: #3b82f6; align-self: flex-end; text-align: right; }
        .suyo { background-color: #334155; align-self: flex-start; text-align: left; }
        .input-chat-area { display: flex; gap: 5px; }
    </style>
</head>
<body>

    <div id="pantalla-registro" class="container">
        <h1>üåê Latice</h1>
        <div class="card">
            <h3>üöÄ Crear Perfil</h3>
            <div style="text-align: center; margin-bottom: 20px;">
    <button onclick="entrarConGoogle()" style="
        background-color: #4285F4; 
        color: white; 
        padding: 12px 24px; 
        border: none; 
        border-radius: 4px; 
        font-size: 16px; 
        font-weight: bold; 
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
        üá¨ Entrar con Google
    </button>
</div>
            <input type="text" id="nombre" placeholder="Tu Nombre">
            <select id="facultad">
                <option value="Ingenier√≠a">Ingenier√≠a</option>
                <option value="Ciencias">Ciencias</option>
            </select>
            <input type="text" id="intereses" placeholder="Intereses (ej: python, futbol)">
            <input type="text" id="mision" placeholder="Misi√≥n hoy">
            <button onclick="registrar()">Entrar</button>
        </div>
    </div>

    <div id="pantalla-radar" style="display:none;">
        <h3>üì° Radar</h3>
        <p>Hola <b id="lbl-usuario"></b></p>
        <button onclick="buscarMatch()">üîÑ Escanear</button>
        <div id="lista-matches"></div>
    </div>

    <div id="pantalla-chat" style="display:none;">
        <h3>üí¨ Chat con <span id="lbl-contacto" style="color:#4ade80"></span></h3>
        <div class="card">
            <div id="caja-chat" class="chat-box"></div>
            <div class="input-chat-area">
                <input type="text" id="msg-input" placeholder="Escribe algo...">
                <button style="width: 60px;" onclick="enviarMensaje()">‚û§</button>
            </div>
            <button onclick="volverRadar()" style="background:#ef4444; margin-top:5px">Salir</button>
        </div>
    </div>

<script type="module">
  // 1. Importamos las herramientas de Google directamente de internet
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // 2. TUS LLAVES 
  const firebaseConfig = {
    apiKey: "AIzaSyC9Zr4kh6NsgB0qB1SUppUsvIzkBahnOQc",
    authDomain: "latice-auth.firebaseapp.com",
    projectId: "latice-auth",
    storageBucket: "latice-auth.firebasestorage.app",
    messagingSenderId: "861296002124",
    appId: "1:861296002124:web:b920a850717af71e4b60e9",
    measurementId: "G-MMR4331SSX"
  };

  // 3. Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // 4. La Funci√≥n del Login (La hacemos global con window)
  window.entrarConGoogle = async function() {
      try {
          // Esto abre la ventana emergente de Google
          const result = await signInWithPopup(auth, provider);
          
          // ¬°Si llegamos aqu√≠, el usuario entr√≥ con √©xito!
          const user = result.user;
          console.log("Usuario conectado:", user.displayName);
          console.log("Correo:", user.email);
          console.log("Foto:", user.photoURL);

          // Mostramos alerta de √©xito (Temporal)
          alert("¬°Bienvenido a Latice, " + user.displayName + "!");

          // AQU√ç ES DONDE LUEGO CONECTAREMOS CON LA BASE DE DATOS
          // Para guardar su info en el backend...
          
      } catch (error) {
          console.error("Error en login:", error);
          alert("Error: " + error.message);
      }
  }
</script>

    <script>
        // --- CONFIGURACI√ìN ---
        const IP = "192.168.100.248"; 
        const API = ``;

        let miId = null; 
        let miNombre = "";
        let contactoActual = "";
        let chatInterval = null;

        async function registrar() {
            miNombre = document.getElementById('nombre').value;
            const facultad = document.getElementById('facultad').value;
            const intereses = document.getElementById('intereses').value.split(',');
            const mision = document.getElementById('mision').value;

            await fetch(`${API}/registrar`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre: miNombre, facultad, modo_faro: true, mision, intereses })
            }).then(r => r.json()).then(data => {
                miId = data.id_asignado;
                document.getElementById('pantalla-registro').style.display = 'none';
                document.getElementById('pantalla-radar').style.display = 'block';
                document.getElementById('lbl-usuario').innerText = miNombre;
            });
        }

        async function buscarMatch() {
            const lista = document.getElementById('lista-matches');
            lista.innerHTML = "Escaneando...";
            const res = await fetch(`${API}/buscar-match/${miId}`);
            const data = await res.json();
            lista.innerHTML = "";

            if (data.top_matches) {
                data.top_matches.forEach(p => {
                    lista.innerHTML += `
                        <div class="card">
                            <span style="color:#4ade80; float:right">${p.match_percent}%</span>
                            <b>${p.nombre}</b><br><small>${p.mision}</small><br>
                            <small style="color:#94a3b8">Com√∫n: ${p.temas_comun.join(", ")}</small>
                            <button style="background:#10b981" onclick="abrirChat('${p.nombre}')">üí¨ Conectar</button>
                        </div>`;
                });
            }
        }

        function abrirChat(nombreContacto) {
            contactoActual = nombreContacto;
            document.getElementById('pantalla-radar').style.display = 'none';
            document.getElementById('pantalla-chat').style.display = 'block';
            document.getElementById('lbl-contacto').innerText = contactoActual;
            
            // Iniciar actualizaci√≥n autom√°tica del chat cada 2 segundos
            cargarMensajes();
            chatInterval = setInterval(cargarMensajes, 2000);
        }

        async function enviarMensaje() {
            const txt = document.getElementById('msg-input').value;
            if(!txt) return;

            await fetch(`${API}/enviar-mensaje`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ de_usuario: miNombre, para_usuario: contactoActual, texto: txt })
            });
            document.getElementById('msg-input').value = "";
            cargarMensajes(); // Recargar r√°pido
        }

        async function cargarMensajes() {
            const res = await fetch(`${API}/leer-mensajes/${miNombre}/${contactoActual}`);
            const msgs = await res.json();
            const caja = document.getElementById('caja-chat');
            caja.innerHTML = "";

            msgs.forEach(m => {
                const clase = (m.de_usuario === miNombre) ? 'mio' : 'suyo';
                //poner hora al lado del mensaje
                let hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                //ponerla chiquita al lado del texto
                caja.innerHTML += `
                <div class="mensaje ${clase}"> 
                    ${m.texto}
                    <span style="font-size: 0.7em; opacity: 0.7; margin-left: 10px;">${hora}</span>
                    </div> 
                    `;


            });
            // Auto scroll abajo
            caja.scrollTop = caja.scrollHeight;
        }

        function volverRadar() {
            clearInterval(chatInterval);
            document.getElementById('pantalla-chat').style.display = 'none';
            document.getElementById('pantalla-radar').style.display = 'block';
        }
    </script>
</body>
</html>