<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Latice Chat</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: white; text-align: center; padding: 10px; margin: 0;}
        input, select { padding: 12px; width: 90%; margin: 8px 0; border-radius: 8px; border: none; background: #334155; color: white; font-size: 16px; }
        button { background-color: #3b82f6; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 10px;}
        .card { background-color: #1e293b; padding: 20px; margin: 15px auto; border-radius: 12px; text-align: left; max-width: 500px; }
        
        /* ESTILOS DEL CHAT */
        .chat-box { height: 300px; overflow-y: scroll; background: #020617; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; }
        .mensaje { padding: 8px 12px; margin: 5px; border-radius: 15px; max-width: 70%; width: fit-content; }
        .mio { background-color: #3b82f6; align-self: flex-end; text-align: right; }
        .suyo { background-color: #334155; align-self: flex-start; text-align: left; }
        .input-chat-area { display: flex; gap: 5px; }
    </style>
</head>
<body>

    <div id="pantalla-registro" class="container">
        <h1>üåê Latice</h1>
        <div class="card">
            <h3>üöÄ Crear Perfil</h3>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="entrarConGoogle()" style="
                    background-color: #4285F4; 
                    color: white; 
                    padding: 12px 24px; 
                    border: none; 
                    border-radius: 4px; 
                    font-size: 16px; 
                    font-weight: bold; 
                    cursor: pointer;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                    üá¨ Entrar con Google
                </button>
                <p style="font-size: 12px; color: #94a3b8; margin-top: 10px;">o completa tus datos manual:</p>
            </div>

            <input type="text" id="nombre" placeholder="Tu Nombre">
            <select id="facultad">
                <option value="Ingenier√≠a">Ingenier√≠a</option>
                <option value="Ciencias">Ciencias</option>
                <option value="Derecho">Derecho</option>
                <option value="Arquitectura">Arquitectura</option>
            </select>
            <input type="text" id="intereses" placeholder="Intereses (ej: python, futbol)">
            <input type="text" id="mision" placeholder="Misi√≥n hoy (ej: buscar socio)">
            <button onclick="registrar()">Entrar</button>
        </div>
    </div>

    <div id="pantalla-radar" style="display:none;">
        <h3>üì° Radar</h3>
        <p>Hola <b id="lbl-usuario"></b></p>
        <button onclick="buscarMatch()">üîÑ Escanear</button>
        <div id="lista-matches"></div>
    </div>

    <div id="pantalla-chat" style="display:none;">
        <h3>üí¨ Chat con <span id="lbl-contacto" style="color:#4ade80"></span></h3>
        <div class="card">
            <div id="caja-chat" class="chat-box"></div>
            <div class="input-chat-area">
                <input type="text" id="msg-input" placeholder="Escribe algo...">
                <button style="width: 60px;" onclick="enviarMensaje()">‚û§</button>
            </div>
            <button onclick="volverRadar()" style="background:#ef4444; margin-top:5px">Salir</button>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyC9Zr4kh6NsgB0qB1SUppUsvIzkBahnOQc",
        authDomain: "latice-auth.firebaseapp.com",
        projectId: "latice-auth",
        storageBucket: "latice-auth.firebasestorage.app",
        messagingSenderId: "861296002124",
        appId: "1:861296002124:web:b920a850717af71e4b60e9",
        measurementId: "G-MMR4331SSX"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      window.entrarConGoogle = async function() {
          try {
              // 1. Google nos da el usuario
              const result = await signInWithPopup(auth, provider);
              const user = result.user;
              const email = user.email;
              
              console.log("Verificando email:", email);

              // 2. Preguntamos a TU Backend si ya existe
              const resp = await fetch(`/validar-google/${email}`);
              const data = await resp.json();

              if (data.existe) {
                  // --- YA EXISTE: LOGIN DIRECTO ---
                  alert("¬°Bienvenido de nuevo, " + data.nombre + "!");
                  window.iniciarApp(data.id, data.nombre);
              } else {
                  // --- ES NUEVO: REGISTRO ---
                  alert("Hola " + user.displayName + ". \nPor favor completa tu Facultad y Misi√≥n para terminar.");
                  
                  // Rellenamos el nombre
                  document.getElementById('nombre').value = user.displayName;
                  
                  // Guardamos el email para usarlo al dar click en "Entrar"
                  window.emailGoogle = email; 
              }
              
          } catch (error) {
              console.error("Error:", error);
              alert("Error: " + error.message);
          }
      }
    </script>

    <script>
        // --- CONFIGURACI√ìN ---
        const API = ""; 

        let miId = null; 
        let miNombre = "";
        let contactoActual = "";
        let chatInterval = null;
        
        window.emailGoogle = ""; // Variable temporal para el correo

        // Funci√≥n auxiliar para iniciar la interfaz
        window.iniciarApp = function(id, nombre) {
            miId = id;
            miNombre = nombre;
            document.getElementById('pantalla-registro').style.display = 'none';
            document.getElementById('pantalla-radar').style.display = 'block';
            document.getElementById('lbl-usuario').innerText = miNombre;
        }
        
        async function registrar() {
        // 1. Tomamos los datos
        miNombre = document.getElementById('nombre').value;
        const facultad = document.getElementById('facultad').value;
        const intereses = document.getElementById('intereses').value.split(',');
        const mision = document.getElementById('mision').value;

        // 2. Usamos el email de Google (o inventamos uno si es prueba manual)
        const emailFinal = window.emailGoogle || (miNombre.replace(/\s/g, '') + "@latice.test");
        console.log("Intentando registrar a:", miNombre, emailFinal);

        try {
            const response = await fetch(`${API}/registrar`, {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    nombre: miNombre, 
                    email: emailFinal,   
                    facultad: facultad, 
                    modo_faro: true, 
                    mision: mision, 
                    intereses: intereses 
                })
            });

            // 3. SI EL SERVIDOR FALLA, NOS AVISA AQU√ç
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(JSON.stringify(errorData));
            }

            // 4. Si todo sale bien, entramos
            const data = await response.json();
            window.iniciarApp(data.id, data.nombre);

        } catch (error) {
            console.error("Error grave:", error);
            alert("‚ö†Ô∏è Error al registrar: Probablemente el email ya existe o el servidor fall√≥.\n" + error.message);
        }
    }

        async function buscarMatch() {
            const lista = document.getElementById('lista-matches');
            lista.innerHTML = "Escaneando...";
            const res = await fetch(`${API}/buscar-match/${miId}`);
            const data = await res.json();
            lista.innerHTML = "";

            if (data.top_matches) {
                data.top_matches.forEach(p => {
                    lista.innerHTML += `
                        <div class="card">
                            <span style="color:#4ade80; float:right">${p.match_percent}%</span>
                            <b>${p.nombre}</b><br><small>${p.mision}</small><br>
                            <small style="color:#94a3b8">Com√∫n: ${p.temas_comun.join(", ")}</small>
                            <button style="background:#10b981" onclick="abrirChat('${p.nombre}')">üí¨ Conectar</button>
                        </div>`;
                });
            }
        }

        function abrirChat(nombreContacto) {
            contactoActual = nombreContacto;
            document.getElementById('pantalla-radar').style.display = 'none';
            document.getElementById('pantalla-chat').style.display = 'block';
            document.getElementById('lbl-contacto').innerText = contactoActual;
            
            cargarMensajes();
            chatInterval = setInterval(cargarMensajes, 2000);
        }

        async function enviarMensaje() {
            const txt = document.getElementById('msg-input').value;
            if(!txt) return;

            await fetch(`${API}/enviar-mensaje`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ de_usuario: miNombre, para_usuario: contactoActual, texto: txt })
            });
            document.getElementById('msg-input').value = "";
            cargarMensajes(); 
        }

        async function cargarMensajes() {
            const res = await fetch(`${API}/leer-mensajes/${miNombre}/${contactoActual}`);
            const msgs = await res.json();
            const caja = document.getElementById('caja-chat');
            caja.innerHTML = "";

            msgs.forEach(m => {
                const clase = (m.de_usuario === miNombre) ? 'mio' : 'suyo';
                let hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                caja.innerHTML += `
                <div class="mensaje ${clase}"> 
                    ${m.texto}
                    <span style="font-size: 0.7em; opacity: 0.7; margin-left: 10px;">${hora}</span>
                </div>`;
            });
            caja.scrollTop = caja.scrollHeight;
        }

        function volverRadar() {
            clearInterval(chatInterval);
            document.getElementById('pantalla-chat').style.display = 'none';
            document.getElementById('pantalla-radar').style.display = 'block';
        }
    </script>
</body>
</html>